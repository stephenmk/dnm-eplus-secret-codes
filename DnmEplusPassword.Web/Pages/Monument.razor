@page "/monument"
@using DnmEplusPassword.Library
@using DnmEplusPassword.Web.Components
@using DnmEplusPassword.Web.Models

<PageTitle>Monument</PageTitle>

<h1>Monument</h1>

<div style="max-width: 400px;">
    <InputRecipient Recipient="@Model.Recipient" />
    <InputDecoration Decoration="@Model.Decoration" />
    <InputPrice Price="@Model.Price" />
    <InputPlacementAcre PlacementAcre="@Model.PlacementAcre" />
    <InputLanguage Language="@Model.Language" />

    <button class="btn btn-primary" @onclick="Model.GeneratePassword">
        Generate Secret Code
    </button>
</div>

@if (Model.SecretCode is not null)
{
    <OutputSecretCode SecretCode="@Model.SecretCode" />
}

@code {
    private MonumentModel Model = new();

    private sealed class MonumentModel
    {
        public Recipient Recipient { get; set; } = new();
        public Decoration Decoration { get; set; } = new();
        public Price Price { get; set; } = new();
        public PlacementAcre PlacementAcre { get; set; } = new();
        public Language Language { get; set; } = new();
        public SecretCode? SecretCode { get; set; } = null;

        public void GeneratePassword()
        {
            try
            {
                var password = Encoder.Encode
                (
                    codeType: CodeType.Monument,
                    hitRateIndex: 0,
                    recipientTown: Recipient.TownName.PadRight(6, ' '),
                    recipient: Recipient.Name.PadRight(6, ' '),
                    sender: Price.Value.ToString().PadRight(6, ' '),
                    itemId: (ushort)(Decoration.Id % 15),
                    extraData: ((PlacementAcre.Row & 7) << 3) | (PlacementAcre.Col & 7),
                    englishPasswords: Language.IsEnglish
                );
                SecretCode = new()
                {
                    Line1 = password.Item1,
                    Line2 = password.Item2,
                };
            }
            catch
            {
                SecretCode = null;
            }
        }
    }
}
